{
  "rules": {
    ".read": false,
    ".write": false,
    "users": {
      "$userId": {
        ".write": "$userId === auth.uid &&
        					 (
        						 !newData.exists() ||
           				   newData.hasChildren(
                       [
                         'subscribeToNewsletter',
                         'sources',
                         'postsContent',
                         'listeningStats',
                         'totalStats',
                         'deletedPostsMeta',
                         'deletedPostsContent',
                       ]
                     )
         					 )",
        ".read": "$userId === auth.uid",
        "$other": {
          ".validate": false,
        },
        "subscribeToNewsletter": {
          ".validate": "newData.isBoolean()",
        },
        "sources": {
          "$sourceName": {
            ".validate": "newData.hasChildren(
                            [
                              'type',
                              'subscribed',
                              'priority',
                            ]
                          ) &&
                          (
                            (
                             newData.child('type').val() === 'subscription' &&
                             newData.hasChildren(
                              [
                                'subscribed'
                              ]
                             )
                           ) ||
                           (
                             newData.child('type').val() === 'category' &&
                             newData.hasChildren(
                               [
                                 'label',
                                 'labelColor'
                               ]
                             )
                            )
                          )",
            "$other": {
              ".validate": false,
             },
            "type": {
              ".validate": "newData.val() === 'subscription' || newData.val() === 'category'"
            },
            "subscribed": {
              ".validate": "newData.parent().child('type').val() === 'subscription' &&
                            newData.isBoolean()",
            },
            "label": {
              ".validate": "newData.parent().child('type').val() === 'category' &&
                            newData.isString()",
            },
            "labelColor": {
              ".validate": "newData.parent().child('type').val() === 'category' &&
                            newData.isString() &&
                            newData.val().matches(/^#[0-9a-f]{6}$/)",
            },
            "priority": {
              ".validate": "(newData.isNumber() && newData.val() > 1) || newData.val() === false",
            },
          },
        },
        "postsMeta": {
          "$postId": {
            ".validate": "newData.parent().child(
                            'postContent/'
                              + $postId
                          ).exists() &&
                          newData.hasChildren(['preview', 'sourceName']) &&
                          (
                            newData.child('sourceName').val() != 'url' ||
                            newData.hasChild('sourceUrl')
                          ) &&
                          (
                            newData.child('sourceName').val() != 'file' ||
                            newData.hasChild('fileName')
                          )",
            ".indexOn": ["preview","sourceName"],
            "$other": {
                ".validate": false,
             },
            "sourceName": {
              ".validate": "newData.isString() &&
                            root.child(
                              'users/' + $userId + '/sources/' + newData.val()
                            ).exists()",
            },
            "sourceUrl": {
              ".validate": "newData.parent().child('sourceName').val() === 'url' &&
                            newData.isString()",
            },
            "fileName": {
              ".validate": "newData.parent().child('sourceName').val() === 'file' &&
                            newData.isString()",
            },
            "preview": {
              ".validate": "newData.isString() &&
                            newData.val().length !== 0 &&
                            newData.val().length < 50",
            },
          },
        },
        "postsContent": {
          "$postId": {
            ".validate": "newData.isString()",
          },
        },
        "listeningStats": {
          ".write": "$userId === auth.uid &&
        					 	 newData.exists()",
          "$year": {
            ".write": "$userId === auth.uid &&
        					 	   newData.exists()",
            ".validate": "$year >= 2021 && $year <= 3000",
            "$month": {
              ".write": "$userId === auth.uid &&
        					 	     newData.exists()",
              ".validate": "$month >= 1 &&
                            $month <= 12 &&
                            newData.hasChildren([
                              'posts',
                              'paragraphs',
                              'words',
                              'characters'
                            ])",
              "$category": {
                ".validate": "($category === 'posts' ||
                              $category === 'paragraphs' ||
                              $category === 'words' ||
                              $category === 'characters')
                              && newData.isNumber() && (
                                !data.exists() ||
                                data.val() <= newData.val()
                              ) &&
                              newData.val()>0",
              }
            },
          },
        },
        "totalStats": {
          ".validate": "newData.hasChildren([
                          'queuedPosts',
                          'posts',
                          'paragraphs',
                          'words',
                          'characters',
          							])",
          "$category": {
            ".validate": "($category === 'queuedPosts' ||
            							$category === 'posts' ||
                          $category === 'paragraphs' ||
                          $category === 'words' ||
                          $category === 'characters')
                          && newData.isNumber() && (
                            !data.exists() ||
                            data.val() <= newData.val()
                          ) &&
                          newData.val()>0",
          }
        },
        "deletedPostsMeta": {
          "$postId": {
            ".validate": "newData.hasChildren(['preview', 'sourceName']) &&
            							root.child(
                            'users/'
                              + $userId
                              + '/deletedPostsContent/'
                              + $postId
                          ).exists() &&
                          (
                            newData.child('sourceName').val() != 'url' ||
                            newData.hasChild('sourceUrl')
                          ) &&
                          (
                            newData.child('sourceName').val() != 'file' ||
                            newData.hasChild('fileName')
                          )",
            ".indexOn": ["preview","sourceName"],
            "$other": {
                ".validate": false,
             },
            "sourceName": {
              ".validate": "newData.isString() &&
                            root.child(
                              'users/' + $userId + '/sources/' + newData.val()
                            ).exists()",
            },
            "sourceUrl": {
              ".validate": "newData.parent().child('sourceName').val() === 'url' &&
                            newData.isString()",
            },
            "fileName": {
              ".validate": "newData.parent().child('sourceName').val() === 'file' &&
                            newData.isString()",
            },
            "preview": {
              ".validate": "newData.isString() &&
                            newData.val().length !== 0 &&
                            newData.val().length < 50",
            },
          },
        },
        "deletedPostsContent": {
          "$postId": {
            ".validate": "newData.isString() && newData.val().length !== 0",
          }
        },
      },
    },
  },
}

